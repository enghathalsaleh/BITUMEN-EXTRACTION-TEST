<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار استخلاص البيتومين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Cairo', sans-serif; }
        
        .print-only { display: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { -webkit-print-color-adjust: exact; }
        }

        .custom-input {
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .custom-input:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
        }
        
        .dark .custom-input {
            border-color: #374151;
            background-color: #1f2937;
            color: #f9fafb;
        }
        
        .dark .custom-input:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-cairo">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-primary mb-2">BITUMEN EXTRACTION TEST</h1>
            <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300">اختبار استخلاص البيتومين</h2>
        </div>

        <!-- Project Information -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
            <h3 class="text-xl font-semibold mb-4 text-primary">معلومات المشروع</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">اسم المشروع</label>
                    <input type="text" id="projectName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="أدخل اسم المشروع">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">اسم المقاول</label>
                    <input type="text" id="contractorName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="أدخل اسم المقاول">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">نوع الطبقة</label>
                    <select id="layerType" class="w-full px-3 py-2 text-base rounded-lg custom-input">
                        <option value="">اختر نوع الطبقة</option>
                        <option value="B.W.C">B.W.C</option>
                        <option value="B.B.C">B.B.C</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">تاريخ الاختبار</label>
                    <input type="date" id="testDate" class="w-full px-3 py-2 text-base rounded-lg custom-input">
                </div>
            </div>
        </div>

        <!-- Sample Input Form -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-8 shadow-lg no-print">
            <h3 class="text-xl font-semibold mb-4 text-primary">إضافة عينة جديدة</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">اسم العينة</label>
                    <input type="text" id="sampleName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="مثال: عينة-1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن العينة قبل الاختبار (جرام)</label>
                    <input type="number" id="sampleWeightBefore" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن الفلتر قبل الاختبار (جرام)</label>
                    <input type="number" id="filterWeightBefore" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن العينة بعد الاختبار (جرام)</label>
                    <input type="number" id="sampleWeightAfter" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">وزن الفلتر بعد الاختبار (جرام)</label>
                    <input type="number" id="filterWeightAfter" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div class="flex items-end">
                    <button onclick="addSample()" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        إضافة العينة
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-primary text-white">
                <h3 class="text-xl font-semibold">النتائج</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-right text-sm font-semibold">#</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">اسم العينة</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن العينة قبل (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن الفلتر قبل (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن العينة بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن الفلتر بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن التربة على الفلتر (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن العينة الكلي بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">وزن البيتومين (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">نسبة البيتومين (%)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable" class="divide-y divide-gray-200 dark:divide-gray-600">
                        <tr>
                            <td colspan="11" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                لا توجد عينات بعد. قم بإضافة عينة جديدة.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap gap-4 justify-center no-print">
            <button onclick="printResults()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
                طباعة النتائج
            </button>
            <button onclick="exportToExcel()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
                تصدير إلى Excel
            </button>
            <button onclick="clearAll()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
                مسح جميع البيانات
            </button>
        </div>

        <!-- Print Header (only visible when printing) -->
        <div class="print-only text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">BITUMEN EXTRACTION TEST</h1>
            <h2 class="text-xl font-semibold mb-4">اختبار استخلاص البيتومين</h2>
            <div class="text-sm mb-4">
                <p><strong>اسم المشروع:</strong> <span id="printProjectName"></span></p>
                <p><strong>اسم المقاول:</strong> <span id="printContractorName"></span></p>
                <p><strong>نوع الطبقة:</strong> <span id="printLayerType"></span></p>
                <p><strong>تاريخ الاختبار:</strong> <span id="printTestDate"></span></p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Confirmations -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <p id="confirmMessage" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">إلغاء</button>
                <button id="confirmButton" onclick="confirmAction()" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">تأكيد</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        let samples = [];
        let confirmCallback = null;

        function showConfirmDialog(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-blue-600 rounded">موافق</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addSample() {
            const sampleName = document.getElementById('sampleName').value.trim();
            const sampleWeightBefore = parseFloat(document.getElementById('sampleWeightBefore').value);
            const filterWeightBefore = parseFloat(document.getElementById('filterWeightBefore').value);
            const sampleWeightAfter = parseFloat(document.getElementById('sampleWeightAfter').value);
            const filterWeightAfter = parseFloat(document.getElementById('filterWeightAfter').value);

            // Validation
            if (!sampleName) {
                showAlert('يرجى إدخال اسم العينة');
                return;
            }

            if (samples.length >= 50) {
                showAlert('لا يمكن إضافة أكثر من 50 عينة');
                return;
            }

            if (samples.some(sample => sample.name === sampleName)) {
                showAlert('اسم العينة موجود بالفعل');
                return;
            }

            if (isNaN(sampleWeightBefore) || isNaN(filterWeightBefore) || 
                isNaN(sampleWeightAfter) || isNaN(filterWeightAfter)) {
                showAlert('يرجى إدخال جميع الأوزان بشكل صحيح');
                return;
            }

            if (sampleWeightBefore <= 0 || filterWeightBefore < 0 || 
                sampleWeightAfter < 0 || filterWeightAfter < 0) {
                showAlert('الأوزان يجب أن تكون أرقام موجبة');
                return;
            }

            // Calculations
            const soilOnFilter = filterWeightAfter - filterWeightBefore;
            const totalSampleWeightAfter = sampleWeightAfter + soilOnFilter;
            const bitumenWeight = sampleWeightBefore - totalSampleWeightAfter;
            const bitumenPercentage = (bitumenWeight / sampleWeightBefore) * 100;

            const sample = {
                name: sampleName,
                sampleWeightBefore,
                filterWeightBefore,
                sampleWeightAfter,
                filterWeightAfter,
                soilOnFilter,
                totalSampleWeightAfter,
                bitumenWeight,
                bitumenPercentage
            };

            samples.push(sample);
            
            // Clear form
            document.getElementById('sampleName').value = '';
            document.getElementById('sampleWeightBefore').value = '';
            document.getElementById('filterWeightBefore').value = '';
            document.getElementById('sampleWeightAfter').value = '';
            document.getElementById('filterWeightAfter').value = '';

            // Auto-generate next sample name
            const nextSampleNumber = samples.length + 1;
            document.getElementById('sampleName').value = `عينة-${nextSampleNumber}`;

            updateResultsTable();
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsTable');
            
            if (samples.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                            لا توجد عينات بعد. قم بإضافة عينة جديدة.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = samples.map((sample, index) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3 text-sm">${index + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium">${sample.name}</td>
                    <td class="px-4 py-3 text-sm">${sample.sampleWeightBefore.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.filterWeightBefore.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.sampleWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.filterWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.soilOnFilter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.totalSampleWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm">${sample.bitumenWeight.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-primary">${sample.bitumenPercentage.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-sm no-print">
                        <button onclick="deleteSample(${index})" class="text-red-600 hover:text-red-800 text-xs">
                            حذف
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteSample(index) {
            showConfirmDialog('هل أنت متأكد من حذف هذه العينة؟', () => {
                samples.splice(index, 1);
                updateResultsTable();
            });
        }

        function printResults() {
            if (samples.length === 0) {
                showAlert('لا توجد نتائج للطباعة');
                return;
            }

            // Update print header with project info
            document.getElementById('printProjectName').textContent = document.getElementById('projectName').value || 'غير محدد';
            document.getElementById('printContractorName').textContent = document.getElementById('contractorName').value || 'غير محدد';
            document.getElementById('printLayerType').textContent = document.getElementById('layerType').value || 'غير محدد';
            document.getElementById('printTestDate').textContent = document.getElementById('testDate').value || 'غير محدد';

            window.print();
        }

        function exportToExcel() {
            if (samples.length === 0) {
                showAlert('لا توجد بيانات للتصدير');
                return;
            }

            const projectInfo = [
                ['اسم المشروع', document.getElementById('projectName').value || 'غير محدد'],
                ['اسم المقاول', document.getElementById('contractorName').value || 'غير محدد'],
                ['نوع الطبقة', document.getElementById('layerType').value || 'غير محدد'],
                ['تاريخ الاختبار', document.getElementById('testDate').value || 'غير محدد'],
                [''],
                ['BITUMEN EXTRACTION TEST - اختبار استخلاص البيتومين'],
                ['']
            ];

            const headers = [
                '#', 'اسم العينة', 'وزن العينة قبل (جم)', 'وزن الفلتر قبل (جم)',
                'وزن العينة بعد (جم)', 'وزن الفلتر بعد (جم)', 'وزن التربة على الفلتر (جم)',
                'وزن العينة الكلي بعد (جم)', 'وزن البيتومين (جم)', 'نسبة البيتومين (%)'
            ];

            const data = samples.map((sample, index) => [
                index + 1,
                sample.name,
                sample.sampleWeightBefore.toFixed(2),
                sample.filterWeightBefore.toFixed(2),
                sample.sampleWeightAfter.toFixed(2),
                sample.filterWeightAfter.toFixed(2),
                sample.soilOnFilter.toFixed(2),
                sample.totalSampleWeightAfter.toFixed(2),
                sample.bitumenWeight.toFixed(2),
                sample.bitumenPercentage.toFixed(2) + '%'
            ]);

            const wsData = [...projectInfo, headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Bitumen Test Results');

            // Add some styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; ++R) {
                for (let C = 0; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({c: C, r: R});
                    if (!ws[cell_address]) continue;
                    
                    if (R === projectInfo.length - 1) { // Headers row
                        ws[cell_address].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: "5D5CDE" } },
                            color: { rgb: "FFFFFF" }
                        };
                    }
                }
            }

            const fileName = `Bitumen_Test_Results_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function clearAll() {
            if (samples.length === 0) {
                showAlert('لا توجد بيانات للمسح');
                return;
            }

            showConfirmDialog('هل أنت متأكد من مسح جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.', () => {
                samples = [];
                updateResultsTable();
                
                // Clear project info
                document.getElementById('projectName').value = '';
                document.getElementById('contractorName').value = '';
                document.getElementById('layerType').value = '';
                document.getElementById('testDate').value = '';
                
                // Clear sample form
                document.getElementById('sampleName').value = 'عينة-1';
                document.getElementById('sampleWeightBefore').value = '';
                document.getElementById('filterWeightBefore').value = '';
                document.getElementById('sampleWeightAfter').value = '';
                document.getElementById('filterWeightAfter').value = '';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sampleName').value = 'عينة-1';
            document.getElementById('testDate').value = new Date().toISOString().slice(0, 10);
        });
    </script>
</body>
</html>
