<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار استخلاص البيتومين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Cairo', sans-serif; }
        
        .print-only { display: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { 
                -webkit-print-color-adjust: exact; 
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .print-table {
                font-size: 10px !important;
                width: 100% !important;
            }
            
            .print-table th,
            .print-table td {
                padding: 4px 2px !important;
                border: 1px solid #00685E !important;
                white-space: nowrap !important;
            }
            
            .print-table th {
                background-color: #00685E !important;
                color: white !important;
                font-weight: bold !important;
            }
            
            .print-table tbody tr:nth-child(even) {
                background-color: #f8fffe !important;
            }
            
            @page {
                size: A4 landscape;
                margin: 1cm;
            }
        }

        .custom-input {
            border: 2px solid #8BAA99;
            transition: all 0.3s ease;
        }
        
        .custom-input:focus {
            border-color: #00685E;
            box-shadow: 0 0 0 3px rgba(0, 104, 94, 0.1);
        }
        
        .dark .custom-input {
            border-color: #8BAA99;
            background-color: #101820;
            color: #f9fafb;
        }
        
        .dark .custom-input:focus {
            border-color: #00A399;
            box-shadow: 0 0 0 3px rgba(0, 163, 153, 0.2);
        }
        
        .brand-gradient {
            background: linear-gradient(135deg, #00685E 0%, #8BAA99 100%);
        }
        
        .brand-card {
            background: linear-gradient(145deg, rgba(139, 170, 153, 0.1) 0%, rgba(0, 104, 94, 0.05) 100%);
            border: 1px solid rgba(139, 170, 153, 0.2);
        }
        
        .dark .brand-card {
            background: linear-gradient(145deg, rgba(0, 163, 153, 0.1) 0%, rgba(139, 170, 153, 0.05) 100%);
            border: 1px solid rgba(0, 163, 153, 0.2);
        }
        
        .accent-orange { color: #E59256; }
        .accent-gold { color: #F2C75C; }
        .accent-blue { color: #006797; }
        .accent-teal { color: #00A399; }
        .accent-brown { color: #B98346; }
        .accent-red { color: #A13525; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        primary: '#00685E',
                        secondary: '#8BAA99',
                        dark: '#101820',
                        accent: {
                            gold: '#F2C75C',
                            orange: '#E59256',
                            red: '#A13525',
                            blue: '#006797',
                            teal: '#00A399',
                            brown: '#B98346'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-cairo">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8 no-print">
            <div class="brand-gradient text-white py-8 px-6 rounded-xl shadow-2xl mb-6">
                <h1 class="text-4xl font-bold mb-2">BITUMEN EXTRACTION TEST</h1>
                <h2 class="text-2xl font-semibold opacity-90">اختبار استخلاص البيتومين</h2>
                <div class="mt-4 flex justify-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-orange-400"></div>
                    <div class="w-3 h-3 rounded-full bg-blue-400"></div>
                </div>
            </div>
        </div>

        <!-- Project Information -->
        <div class="brand-card rounded-lg p-6 mb-8 shadow-lg">
            <h3 class="text-xl font-semibold mb-4 text-primary flex items-center">
                <span class="w-2 h-6 bg-primary rounded-full ml-2"></span>
                معلومات المشروع
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">اسم المشروع</label>
                    <input type="text" id="projectName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="أدخل اسم المشروع">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">اسم المقاول</label>
                    <input type="text" id="contractorName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="أدخل اسم المقاول">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">نوع الطبقة</label>
                    <select id="layerType" class="w-full px-3 py-2 text-base rounded-lg custom-input">
                        <option value="">اختر نوع الطبقة</option>
                        <option value="B.W.C">B.W.C</option>
                        <option value="B.B.C">B.B.C</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">تاريخ الاختبار</label>
                    <input type="date" id="testDate" class="w-full px-3 py-2 text-base rounded-lg custom-input">
                </div>
            </div>
        </div>

        <!-- Sample Input Form -->
        <div class="brand-card rounded-lg p-6 mb-8 shadow-lg no-print">
            <h3 class="text-xl font-semibold mb-4 text-primary flex items-center">
                <span class="w-2 h-6 bg-accent-teal rounded-full ml-2"></span>
                إضافة عينة جديدة
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">اسم العينة</label>
                    <input type="text" id="sampleName" class="w-full px-3 py-2 text-base rounded-lg custom-input" placeholder="مثال: عينة-1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن العينة قبل الاختبار (جرام)</label>
                    <input type="number" id="sampleWeightBefore" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن الفلتر قبل الاختبار (جرام)</label>
                    <input type="number" id="filterWeightBefore" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">وزن العينة بعد الاختبار (جرام)</label>
                    <input type="number" id="sampleWeightAfter" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">وزن الفلتر بعد الاختبار (جرام)</label>
                    <input type="number" id="filterWeightAfter" class="w-full px-3 py-2 text-base rounded-lg custom-input" step="0.01" placeholder="0.00">
                </div>
                <div class="flex items-end">
                    <button onclick="addSample()" class="w-full brand-gradient hover:opacity-90 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-lg">
                        إضافة العينة
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="px-6 py-4 brand-gradient text-white">
                <h3 class="text-xl font-semibold flex items-center">
                    <span class="w-2 h-6 bg-white rounded-full ml-2 opacity-80"></span>
                    النتائج
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full print-table">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">#</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">اسم العينة</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن العينة قبل (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن الفلتر قبل (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن العينة بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن الفلتر بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن التربة على الفلتر (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن العينة الكلي بعد (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300">وزن البيتومين (جم)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300 accent-gold">نسبة البيتومين (%)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold border border-gray-300 no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable" class="divide-y divide-gray-200 dark:divide-gray-600">
                        <tr>
                            <td colspan="11" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                لا توجد عينات بعد. قم بإضافة عينة جديدة.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap gap-4 justify-center no-print">
            <button onclick="printResults()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center">
                <span class="ml-2">📄</span>
                طباعة النتائج
            </button>
            <button onclick="exportToExcel()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center">
                <span class="ml-2">📊</span>
                تصدير إلى Excel
            </button>
            <button onclick="clearAll()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center">
                <span class="ml-2">🗑️</span>
                مسح جميع البيانات
            </button>
        </div>

        <!-- Print Header (only visible when printing) -->
        <div class="print-only text-center mb-8 border-b-4 border-primary pb-6">
            <div class="bg-gradient-to-r from-primary to-secondary text-white py-6 px-8 rounded-lg mb-4">
                <h1 class="text-3xl font-bold mb-2">BITUMEN EXTRACTION TEST</h1>
                <h2 class="text-xl font-semibold opacity-90">اختبار استخلاص البيتومين</h2>
            </div>
            <div class="text-sm mb-4 grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                <div class="text-right">
                    <p><strong class="text-primary">اسم المشروع:</strong> <span id="printProjectName" class="text-gray-700"></span></p>
                    <p><strong class="text-primary">اسم المقاول:</strong> <span id="printContractorName" class="text-gray-700"></span></p>
                </div>
                <div class="text-right">
                    <p><strong class="text-primary">نوع الطبقة:</strong> <span id="printLayerType" class="text-gray-700"></span></p>
                    <p><strong class="text-primary">تاريخ الاختبار:</strong> <span id="printTestDate" class="text-gray-700"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Confirmations -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <p id="confirmMessage" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">إلغاء</button>
                <button id="confirmButton" onclick="confirmAction()" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">تأكيد</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        let samples = [];
        let confirmCallback = null;

        function showConfirmDialog(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-blue-600 rounded">موافق</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addSample() {
            const sampleName = document.getElementById('sampleName').value.trim();
            const sampleWeightBefore = parseFloat(document.getElementById('sampleWeightBefore').value);
            const filterWeightBefore = parseFloat(document.getElementById('filterWeightBefore').value);
            const sampleWeightAfter = parseFloat(document.getElementById('sampleWeightAfter').value);
            const filterWeightAfter = parseFloat(document.getElementById('filterWeightAfter').value);

            // Validation
            if (!sampleName) {
                showAlert('يرجى إدخال اسم العينة');
                return;
            }

            if (samples.length >= 50) {
                showAlert('لا يمكن إضافة أكثر من 50 عينة');
                return;
            }

            if (samples.some(sample => sample.name === sampleName)) {
                showAlert('اسم العينة موجود بالفعل');
                return;
            }

            if (isNaN(sampleWeightBefore) || isNaN(filterWeightBefore) || 
                isNaN(sampleWeightAfter) || isNaN(filterWeightAfter)) {
                showAlert('يرجى إدخال جميع الأوزان بشكل صحيح');
                return;
            }

            if (sampleWeightBefore <= 0 || filterWeightBefore < 0 || 
                sampleWeightAfter < 0 || filterWeightAfter < 0) {
                showAlert('الأوزان يجب أن تكون أرقام موجبة');
                return;
            }

            // Calculations
            const soilOnFilter = filterWeightAfter - filterWeightBefore;
            const totalSampleWeightAfter = sampleWeightAfter + soilOnFilter;
            const bitumenWeight = sampleWeightBefore - totalSampleWeightAfter;
            const bitumenPercentage = (bitumenWeight / sampleWeightBefore) * 100;

            const sample = {
                name: sampleName,
                sampleWeightBefore,
                filterWeightBefore,
                sampleWeightAfter,
                filterWeightAfter,
                soilOnFilter,
                totalSampleWeightAfter,
                bitumenWeight,
                bitumenPercentage
            };

            samples.push(sample);
            
            // Clear form
            document.getElementById('sampleName').value = '';
            document.getElementById('sampleWeightBefore').value = '';
            document.getElementById('filterWeightBefore').value = '';
            document.getElementById('sampleWeightAfter').value = '';
            document.getElementById('filterWeightAfter').value = '';

            // Auto-generate next sample name
            const nextSampleNumber = samples.length + 1;
            document.getElementById('sampleName').value = `عينة-${nextSampleNumber}`;

            updateResultsTable();
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsTable');
            
            if (samples.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                            لا توجد عينات بعد. قم بإضافة عينة جديدة.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = samples.map((sample, index) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 ${index % 2 === 0 ? 'bg-gray-25' : ''}">
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-medium">${index + 1}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 font-medium accent-teal">${sample.name}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${sample.sampleWeightBefore.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${sample.filterWeightBefore.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${sample.sampleWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center">${sample.filterWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center accent-blue">${sample.soilOnFilter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center accent-brown">${sample.totalSampleWeightAfter.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center accent-orange">${sample.bitumenWeight.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 text-center font-bold accent-gold text-lg">${sample.bitumenPercentage.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-sm border border-gray-300 no-print text-center">
                        <button onclick="deleteSample(${index})" class="text-red-600 hover:text-red-800 text-xs bg-red-50 px-2 py-1 rounded">
                            🗑️
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteSample(index) {
            showConfirmDialog('هل أنت متأكد من حذف هذه العينة؟', () => {
                samples.splice(index, 1);
                updateResultsTable();
            });
        }

        function printResults() {
            if (samples.length === 0) {
                showAlert('لا توجد نتائج للطباعة');
                return;
            }

            // Update print header with project info
            document.getElementById('printProjectName').textContent = document.getElementById('projectName').value || 'غير محدد';
            document.getElementById('printContractorName').textContent = document.getElementById('contractorName').value || 'غير محدد';
            document.getElementById('printLayerType').textContent = document.getElementById('layerType').value || 'غير محدد';
            document.getElementById('printTestDate').textContent = document.getElementById('testDate').value || 'غير محدد';

            window.print();
        }

        function exportToExcel() {
            if (samples.length === 0) {
                showAlert('لا توجد بيانات للتصدير');
                return;
            }

            const projectInfo = [
                ['اسم المشروع', document.getElementById('projectName').value || 'غير محدد'],
                ['اسم المقاول', document.getElementById('contractorName').value || 'غير محدد'],
                ['نوع الطبقة', document.getElementById('layerType').value || 'غير محدد'],
                ['تاريخ الاختبار', document.getElementById('testDate').value || 'غير محدد'],
                [''],
                ['BITUMEN EXTRACTION TEST - اختبار استخلاص البيتومين'],
                ['']
            ];

            const headers = [
                '#', 'اسم العينة', 'وزن العينة قبل (جم)', 'وزن الفلتر قبل (جم)',
                'وزن العينة بعد (جم)', 'وزن الفلتر بعد (جم)', 'وزن التربة على الفلتر (جم)',
                'وزن العينة الكلي بعد (جم)', 'وزن البيتومين (جم)', 'نسبة البيتومين (%)'
            ];

            const data = samples.map((sample, index) => [
                index + 1,
                sample.name,
                sample.sampleWeightBefore.toFixed(2),
                sample.filterWeightBefore.toFixed(2),
                sample.sampleWeightAfter.toFixed(2),
                sample.filterWeightAfter.toFixed(2),
                sample.soilOnFilter.toFixed(2),
                sample.totalSampleWeightAfter.toFixed(2),
                sample.bitumenWeight.toFixed(2),
                sample.bitumenPercentage.toFixed(2) + '%'
            ]);

            const wsData = [...projectInfo, headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Bitumen Test Results');

            // Add some styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; ++R) {
                for (let C = 0; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({c: C, r: R});
                    if (!ws[cell_address]) continue;
                    
                    if (R === projectInfo.length - 1) { // Headers row
                        ws[cell_address].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: "5D5CDE" } },
                            color: { rgb: "FFFFFF" }
                        };
                    }
                }
            }

            const fileName = `Bitumen_Test_Results_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function clearAll() {
            if (samples.length === 0) {
                showAlert('لا توجد بيانات للمسح');
                return;
            }

            showConfirmDialog('هل أنت متأكد من مسح جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.', () => {
                samples = [];
                updateResultsTable();
                
                // Clear project info
                document.getElementById('projectName').value = '';
                document.getElementById('contractorName').value = '';
                document.getElementById('layerType').value = '';
                document.getElementById('testDate').value = '';
                
                // Clear sample form
                document.getElementById('sampleName').value = 'عينة-1';
                document.getElementById('sampleWeightBefore').value = '';
                document.getElementById('filterWeightBefore').value = '';
                document.getElementById('sampleWeightAfter').value = '';
                document.getElementById('filterWeightAfter').value = '';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sampleName').value = 'عينة-1';
            document.getElementById('testDate').value = new Date().toISOString().slice(0, 10);
        });
    </script>
</body>
</html>
